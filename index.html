<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚è¦³æ—¥ã‚¯ã‚¤ã‚º</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾© --- */
        :root {
            --bg-color: #1e4620; 
            --chalk-white: #fdfdfd;
            --wood-frame: #8b5a2b;
            --btn-red: #ff6b6b; --btn-blue: #4d96ff;
            --btn-yellow: #feca57; --btn-green: #1dd1a1;
        }
        body {
            background-color: var(--bg-color); color: var(--chalk-white);
            font-family: 'Yomogi', cursive, sans-serif;
            margin: 0; padding: 0; overflow: hidden; touch-action: manipulation;
        }
        .board-frame {
            border: 12px solid var(--wood-frame); box-sizing: border-box;
            height: 100vh; width: 100vw; padding: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        h1, h2 { margin: 0; text-shadow: 1px 1px 2px rgba(255,255,255,0.3); text-align: center; }

        /* --- Client --- */
        #login-screen {
            text-align: center; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        input.name-input {
            font-size: 1.5rem; padding: 10px; border-radius: 5px; border: none;
            width: 80%; margin: 20px 0; font-family: 'Yomogi', cursive; text-align: center;
        }
        button.login-btn {
            font-size: 1.5rem; padding: 10px 30px; background: var(--wood-frame);
            color: white; border: 2px solid white; border-radius: 10px; cursor: pointer;
        }
        .sound-notice { font-size: 0.9rem; color: #feffda; margin-top: 10px; opacity: 0.8; }

        #client-view { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .status-msg { text-align: center; font-size: 1.5rem; height: 3rem; display: flex; align-items: center; justify-content: center;}
        
        /* çµæœç”»é¢ï¼ˆClientç”¨ï¼‰ */
        #result-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100;
        }
        .result-text { font-size: 4rem; font-weight: bold; margin-bottom: 20px; }
        .res-ok { color: #e74c3c; text-shadow: 0 0 10px white; } /* èµ¤ */
        .res-ng { color: #3498db; text-shadow: 0 0 10px white; } /* é’ */

        .btn-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            flex-grow: 1; margin-bottom: 10px;
        }
        .vote-btn {
            border: 3px solid rgba(255,255,255,0.7); border-radius: 10px;
            font-size: 3rem; color: white; cursor: pointer; font-family: 'Yomogi', cursive;
        }
        .vote-btn:active { transform: scale(0.95); }
        .vote-btn.red { background-color: var(--btn-red); }
        .vote-btn.blue { background-color: var(--btn-blue); }
        .vote-btn.yellow { background-color: var(--btn-yellow); }
        .vote-btn.green { background-color: var(--btn-green); }
        .vote-btn:disabled { opacity: 0.3; filter: grayscale(80%); transform: none; }
        .vote-btn.selected { border: 5px solid #fff; transform: scale(0.95); opacity: 1 !important; box-shadow: 0 0 15px white;}

        /* --- Host --- */
        #host-view { width: 100%; height: 100%; position: relative; }
        .host-content { 
            width: 100%; height: 90%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .graph-container {
            display: flex; justify-content: space-around; align-items: flex-end;
            width: 90%; height: 70%; border-bottom: 3px solid white; margin-bottom: 20px;
        }
        .bar-group { width: 15%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; }
        .bar { width: 100%; transition: height 0.5s ease; border: 2px solid white; border-bottom: none; border-radius: 5px 5px 0 0; }
        .bar.red { background: var(--btn-red); } .bar.blue { background: var(--btn-blue); }
        .bar.yellow { background: var(--btn-yellow); } .bar.green { background: var(--btn-green); }
        .bar-label { font-size: 2rem; margin-top: 10px; }
        
        #ranking-list { list-style: none; padding: 0; width: 80%; }
        .rank-item {
            font-size: 2.5rem; border-bottom: 1px dashed rgba(255,255,255,0.5);
            padding: 10px; display: flex; justify-content: space-between;
        }
        .rank-icon { margin-right: 15px; color: gold; }

        .qr-overlay {
            position: absolute; bottom: 30px; right: 30px;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* --- Admin --- */
        #admin-view { width: 100%; height: 100%; overflow-y: auto; text-align: center; }
        .panel { border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .ctrl-btn {
            width: 100%; padding: 15px; font-size: 1.2rem; margin: 5px 0;
            border-radius: 8px; border: none; color: white; cursor: pointer; font-family: 'Yomogi', cursive;
        }
        .bg-green { background: #27ae60; } .bg-red { background: #c0392b; }
        .bg-blue { background: #2980b9; } .bg-gray { background: #7f8c8d; }

        .ans-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; }
        .ans-btn { padding: 15px; font-size: 1.5rem; border: 2px solid white; border-radius: 5px; cursor: pointer; color: #333;}
        
        .sound-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .sound-btn {
            padding: 20px; font-size: 2rem; border-radius: 10px; border: 2px solid white; cursor: pointer;
            font-family: 'Yomogi', cursive;
        }
        .sound-ok { background: #e74c3c; color: white; }
        .sound-ng { background: #34495e; color: white; }
    </style>
</head>
<body>

<div class="board-frame">

    <div id="host-view" class="hidden">
        <h1 id="host-title">ã¿ã‚“ãªã®ç­”ãˆ</h1>
        
        <div id="graph-screen" class="host-content">
            <div class="graph-container">
                <div class="bar-group"><div class="bar red" id="bar-1" style="height:0%"></div><div class="bar-label">1</div></div>
                <div class="bar-group"><div class="bar blue" id="bar-2" style="height:0%"></div><div class="bar-label">2</div></div>
                <div class="bar-group"><div class="bar yellow" id="bar-3" style="height:0%"></div><div class="bar-label">3</div></div>
                <div class="bar-group"><div class="bar green" id="bar-4" style="height:0%"></div><div class="bar-label">4</div></div>
            </div>
            <div style="font-size: 1.5rem;">æŠ•ç¥¨æ•°: <span id="host-votes">0</span></div>
        </div>

        <div id="ranking-screen" class="host-content hidden">
            <h2>ğŸ† ç¾åœ¨ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° ğŸ†</h2>
            <ul id="ranking-list"></ul>
        </div>
        <div class="qr-overlay"><div id="qrcode"></div></div>
    </div>

    <div id="client-view" class="hidden">
        <div id="login-screen">
            <h2>ãŠåå‰ã‚’å…¥ã‚Œã¦ã­</h2>
            <input type="text" id="nickname-input" class="name-input" placeholder="ãŸã‚ã†ãƒ‘ãƒ‘" maxlength="8">
            <button class="login-btn" onclick="registerUser()">å‚åŠ ã™ã‚‹</button>
            <p class="sound-notice">â€»ãƒãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã™ã‚‹ã¨<br>æ­£è§£éŸ³ãŒé³´ã‚Šã¾ã™â™ª</p>
        </div>
        <div id="vote-screen" class="hidden" style="width:100%; height:100%; display:flex; flex-direction:column;">
            <div class="status-msg" id="client-msg">å…ˆç”Ÿã®åˆå›³ã‚’å¾…ã£ã¦ã­</div>
            <div class="btn-grid">
                <button class="vote-btn red" id="vbtn-1" onclick="submitVote(1)">1</button>
                <button class="vote-btn blue" id="vbtn-2" onclick="submitVote(2)">2</button>
                <button class="vote-btn yellow" id="vbtn-3" onclick="submitVote(3)">3</button>
                <button class="vote-btn green" id="vbtn-4" onclick="submitVote(4)">4</button>
            </div>
            <div style="text-align:center; font-size:0.9rem; color:#aaa;">name: <span id="disp-name"></span></div>
        </div>
        <div id="result-overlay" class="hidden">
            <div id="res-icon" class="result-text"></div>
            <div id="res-msg" style="font-size:1.5rem;"></div>
        </div>
    </div>

    <div id="admin-view" class="hidden">
        <h2>å…ˆç”Ÿãƒªãƒ¢ã‚³ãƒ³</h2>
        
        <div class="panel">
            <div>â‘  åŠ¹æœéŸ³ãƒ†ã‚¹ãƒˆï¼ˆå…¨å“¡ã«é³´ã‚Šã¾ã™ï¼‰</div>
            <div class="sound-grid">
                <button class="sound-btn sound-ok" onclick="playSfx('pinpon')">â­•</button>
                <button class="sound-btn sound-ng" onclick="playSfx('gakkari')">âœ–</button>
            </div>
        </div>
        <div class="panel">
            <div>â‘¡ æŠ•ç¥¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</div>
            <button class="ctrl-btn bg-green" onclick="setGameState('open')">æŠ•ç¥¨ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button class="ctrl-btn bg-red" onclick="setGameState('closed')">ç· ã‚åˆ‡ã‚Š</button>
        </div>
        <div class="panel">
            <div>â‘¢ æ­£è§£ç™ºè¡¨ï¼†é›†è¨ˆ</div>
            <p style="margin:5px 0; font-size:0.9rem;">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ­£è§£è€…ã«ãƒ”ãƒ³ãƒãƒ³éŸ³ãŒé³´ã‚Šã¾ã™</p>
            <div class="ans-grid">
                <button class="ans-btn" style="background:var(--btn-red);" onclick="calcScore(1)">1</button>
                <button class="ans-btn" style="background:var(--btn-blue);" onclick="calcScore(2)">2</button>
                <button class="ans-btn" style="background:var(--btn-yellow);" onclick="calcScore(3)">3</button>
                <button class="ans-btn" style="background:var(--btn-green);" onclick="calcScore(4)">4</button>
            </div>
        </div>
        <div class="panel">
            <div>â‘£ æ¬¡ã®å•é¡Œã¸</div>
            <button class="ctrl-btn bg-blue" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>
        </div>
        <div class="panel"><button class="ctrl-btn bg-gray" onclick="fullReset()">å…¨å“¡ã®ç‚¹æ•°ã‚’æ¶ˆå»</button></div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // â–¼â–¼â–¼ ã“ã“ã‚’è‡ªåˆ†ã®Firebaseè¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
    const firebaseConfig = {
        apiKey: "AIzaSyCd7uPG-MIIqTsDEZ4kvWujNLoX3myfLJc",
        authDomain: "kaitou-app.firebaseapp.com",
        databaseURL: "https://kaitou-app-default-rtdb.firebaseio.com",
        projectId: "kaitou-app",
        storageBucket: "kaitou-app.firebasestorage.app",
        messagingSenderId: "357091167079",
        appId: "1:357091167079:web:87573b9fc29060173afdc2",
        measurementId: "G-WY7FCBN4JJ"
    };

    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const role = params.get('role') || 'client';
    let myId = localStorage.getItem('sankan_uid');
    if (!myId) {
        myId = 'u_' + Date.now() + Math.floor(Math.random()*999);
        localStorage.setItem('sankan_uid', myId);
    }
    // è‡ªåˆ†ãŒæœ€å¾Œã«é¸ã‚“ã ç­”ãˆã‚’è¨˜æ†¶
    let myLastChoice = 0; 

    if (role === 'host') initHost();
    else if (role === 'admin') initAdmin();
    else initClient();

    // ==========================================
    // Client
    // ==========================================
    function initClient() {
        document.getElementById('client-view').classList.remove('hidden');
        const sndPinpon = new Audio('./pinpon.mp3');
        const sndGakkari = new Audio('./gakkari.mp3');

        // éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
        const unlockAudio = () => {
            sndPinpon.volume = 0; sndGakkari.volume = 0; 
            sndPinpon.play().then(() => { sndPinpon.pause(); sndPinpon.currentTime=0; sndPinpon.volume=1; });
            sndGakkari.play().then(() => { sndGakkari.pause(); sndGakkari.currentTime=0; sndGakkari.volume=1; });
        };
        const savedName = localStorage.getItem('sankan_name');
        if(savedName) {
            document.body.addEventListener('click', unlockAudio, { once: true });
            document.body.addEventListener('touchstart', unlockAudio, { once: true });
            showVoteScreen(savedName);
        }

        // â˜…â˜…â˜… åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        let lastSfxTime = 0;
        onValue(ref(db, 'state/result'), (snap) => {
            const val = snap.val();
            // æ–°ã—ã„çµæœç™ºè¡¨ãŒã‚ã‚Šã€ã‹ã¤æœ€è¿‘(5ç§’ä»¥å†…)ã®å ´åˆã®ã¿
            if(val && val.t > lastSfxTime) {
                lastSfxTime = val.t;
                if(Date.now() - val.t < 5000) {
                    const overlay = document.getElementById('result-overlay');
                    const icon = document.getElementById('res-icon');
                    const txt = document.getElementById('res-msg');
                    
                    overlay.classList.remove('hidden');
                    
                    if (myLastChoice === val.ans) {
                        // æ­£è§£ï¼
                        icon.innerHTML = "â­•"; icon.className = "result-text res-ok";
                        txt.innerText = "ã›ã„ã‹ã„ï¼";
                        sndPinpon.currentTime = 0; sndPinpon.play();
                    } else {
                        // ä¸æ­£è§£...
                        icon.innerHTML = "âœ–"; icon.className = "result-text res-ng";
                        txt.innerText = "ã–ã‚“ã­ã‚“...";
                        sndGakkari.currentTime = 0; sndGakkari.play();
                    }
                    
                    // 3ç§’å¾Œã«æ¶ˆã™
                    setTimeout(() => { overlay.classList.add('hidden'); }, 4000);
                }
            }
        });

        // å¼·åˆ¶åŠ¹æœéŸ³ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        let lastTestTime = 0;
        onValue(ref(db, 'state/sfx'), (snap) => {
            const val = snap.val();
            if(val && val.t > lastTestTime) {
                lastTestTime = val.t;
                if(Date.now() - val.t < 5000) {
                     if(val.type === 'pinpon') { sndPinpon.currentTime=0; sndPinpon.play(); }
                     else if(val.type === 'gakkari') { sndGakkari.currentTime=0; sndGakkari.play(); }
                }
            }
        });

        onValue(ref(db, 'state'), (snap) => {
            const st = snap.val() || {};
            const btns = document.querySelectorAll('.vote-btn');
            const msg = document.getElementById('client-msg');
            if (st.status === 'open') {
                btns.forEach(b => b.disabled = false);
                msg.innerText = "ç­”ãˆã‚’é¸ã‚“ã§ã­ï¼";
                // é¸æŠçŠ¶æ…‹è§£é™¤
                btns.forEach(b => b.classList.remove('selected'));
                myLastChoice = 0;
                document.getElementById('result-overlay').classList.add('hidden'); // çµæœã‚‚æ¶ˆã™
            } else {
                btns.forEach(b => b.disabled = true);
                if(st.status === 'ranking') msg.innerText = "çµæœç™ºè¡¨ä¸­...";
                else msg.innerText = "å…ˆç”Ÿã®åˆå›³ã‚’å¾…ã£ã¦ã­";
            }
        });

        window.registerUser = () => {
            const name = document.getElementById('nickname-input').value;
            if(!name) return;
            unlockAudio();
            localStorage.setItem('sankan_name', name);
            set(ref(db, 'users/' + myId), { name: name, score: 0 });
            showVoteScreen(name);
        };
    }

    function showVoteScreen(name) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('vote-screen').classList.remove('hidden');
        document.getElementById('disp-name').innerText = name;
        update(ref(db, 'users/' + myId), { name: name });
    }
    
    window.submitVote = (c) => {
        myLastChoice = c; // è‡ªåˆ†ã®ç­”ãˆã‚’è¨˜æ†¶
        document.getElementById('client-msg').innerText = `${c}ç•ªã‚’é¸ã‚“ã ã‚ˆ`;
        // UIæ›´æ–°ï¼ˆé¸ã‚“ã ãƒœã‚¿ãƒ³ã‚’ç›®ç«‹ãŸã›ã‚‹ï¼‰
        document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById(`vbtn-${c}`).classList.add('selected');
        
        set(ref(db, 'votes/' + myId), c);
    };

    // ==========================================
    // Host
    // ==========================================
    function initHost() {
        document.getElementById('host-view').classList.remove('hidden');
        const clientUrl = window.location.href.split('?')[0]; 
        new QRCode(document.getElementById("qrcode"), { text: clientUrl, width: 250, height: 250 });

        onValue(ref(db, 'votes'), (snap) => {
            const votes = snap.val() || {};
            const counts = {1:0, 2:0, 3:0, 4:0};
            let total = 0;
            Object.values(votes).forEach(v => { if(counts[v] !== undefined) { counts[v]++; total++; } });
            document.getElementById('host-votes').innerText = total;
            for(let i=1; i<=4; i++){
                const h = total===0 ? 0 : (counts[i]/total)*80;
                document.getElementById(`bar-${i}`).style.height = `${h}%`;
            }
        });

        onValue(ref(db, 'state/status'), (snap) => {
            const s = snap.val();
            const graph = document.getElementById('graph-screen');
            const rank = document.getElementById('ranking-screen');
            const title = document.getElementById('host-title');
            if(s === 'ranking') {
                graph.classList.add('hidden'); rank.classList.remove('hidden'); title.innerText = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™ºè¡¨ï¼";
                updateRanking();
            } else {
                graph.classList.remove('hidden'); rank.classList.add('hidden'); title.innerText = "ã¿ã‚“ãªã®ç­”ãˆ";
            }
        });
    }

    async function updateRanking() {
        const usersSnap = await get(ref(db, 'users'));
        const users = usersSnap.val() || {};
        let list = Object.values(users);
        list.sort((a, b) => (b.score || 0) - (a.score || 0));
        const ul = document.getElementById('ranking-list');
        ul.innerHTML = "";
        list.slice(0, 5).forEach((u, index) => {
            if(!u.score) u.score = 0;
            const li = document.createElement('li');
            li.className = 'rank-item';
            let icon = index === 0 ? 'ğŸ‘‘' : (index+1) + '.';
            li.innerHTML = `<span><span class="rank-icon">${icon}</span>${u.name}</span> <span>${u.score}pt</span>`;
            ul.appendChild(li);
        });
    }

    // ==========================================
    // Admin
    // ==========================================
    function initAdmin() { document.getElementById('admin-view').classList.remove('hidden'); }
    window.setGameState = (st) => { update(ref(db, 'state'), { status: st }); };
    window.playSfx = (type) => { update(ref(db, 'state/sfx'), { type: type, t: Date.now() }); };

    window.calcScore = async (correctAnswer) => {
        if(!confirm(`æ­£è§£ã¯ã€ ${correctAnswer}ç•ª ã€‘ã§ã™ã‹ï¼Ÿ`)) return;
        
        // 1. ç· ã‚åˆ‡ã‚‹
        await update(ref(db, 'state'), { status: 'closed' });

        // 2. æ­£è§£ç™ºè¡¨ã‚·ã‚°ãƒŠãƒ«ã‚’é€ã‚‹ï¼ˆã“ã‚Œã§ClientãŒä¸€æ–‰ã«åˆ¤å®šï¼†éŸ³å‡ºã—ï¼‰
        await update(ref(db, 'state/result'), { ans: correctAnswer, t: Date.now() });

        // 3. ç‚¹æ•°è¨ˆç®—
        const votesSnap = await get(ref(db, 'votes'));
        const usersSnap = await get(ref(db, 'users'));
        const votes = votesSnap.val() || {};
        const users = usersSnap.val() || {};
        let updates = {};
        Object.keys(votes).forEach(uid => {
            if(votes[uid] === correctAnswer) {
                updates[`users/${uid}/score`] = (users[uid]?.score || 0) + 1;
            }
        });
        if(Object.keys(updates).length > 0) await update(ref(db), updates);
        
        // 4. é»’æ¿ã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¸
        await update(ref(db, 'state'), { status: 'ranking' });
    };
    
    window.nextQuestion = () => {
        if(confirm("æ¬¡ã®å•é¡Œã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ")) {
            set(ref(db, 'votes'), {});
            update(ref(db, 'state'), { status: 'waiting' });
        }
    };
    window.fullReset = () => {
        if(confirm("å…¨å“¡ã®ã‚¹ã‚³ã‚¢ã‚’0ã«ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
            set(ref(db, 'votes'), {}); set(ref(db, 'users'), {});
            update(ref(db, 'state'), { status: 'waiting' });
        }
    };
</script>
</body>
</html>
